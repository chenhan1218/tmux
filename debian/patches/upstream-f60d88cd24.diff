From f60d88cd24cad4b126f641eccfd00a8dfc055113 Mon Sep 17 00:00:00 2001
From: nicm <nicm>
Date: Wed, 29 Apr 2015 15:59:08 +0000
Subject: If default-terminal is set to "screen" or "screen-*", emulate
 screen's historical (incorrect) behaviour for SGR 3 and send smso
 (standout). Previously, we would send sitm (italics) if the terminal
 outside had it and smso otherwise. This was acceptably until recently
 because xterm's terminfo entry lacked sitm, so most users got smso.

People who want italics should set default-terminal to the forthcoming
"tmux" entry (and be prepared to deal with it being missing on older
hosts).

As a side-effect this changes default-terminal to be a server rather
than a session option.

suggested by and ok naddy
---
 options-table.c | 10 +++++-----
 server-fn.c     |  2 +-
 tmux.1          | 25 +++++++++++++------------
 tty.c           | 24 ++++++++++++++++++------
 4 files changed, 37 insertions(+), 24 deletions(-)

--- a/options-table.c
+++ b/options-table.c
@@ -63,6 +63,11 @@
 	  .default_num = 20
 	},
 
+	{ .name = "default-terminal",
+	  .type = OPTIONS_TABLE_STRING,
+	  .default_str = "screen"
+	},
+
 	{ .name = "escape-time",
 	  .type = OPTIONS_TABLE_NUMBER,
 	  .minimum = 0,
@@ -145,11 +150,6 @@
 	  .default_str = _PATH_BSHELL
 	},
 
-	{ .name = "default-terminal",
-	  .type = OPTIONS_TABLE_STRING,
-	  .default_str = "screen"
-	},
-
 	{ .name = "destroy-unattached",
 	  .type = OPTIONS_TABLE_FLAG,
 	  .default_num = 0
--- a/server-fn.c
+++ b/server-fn.c
@@ -36,7 +36,7 @@
 	long	pid;
 
 	if (s != NULL) {
-		term = options_get_string(&s->options, "default-terminal");
+		term = options_get_string(&global_options, "default-terminal");
 		environ_set(env, "TERM", term);
 
 		idx = s->id;
--- a/tmux.1
+++ b/tmux.1
@@ -2142,6 +2142,19 @@
 Set the number of buffers; as new buffers are added to the top of the stack,
 old ones are removed from the bottom if necessary to maintain this maximum
 length.
+.It Ic default-terminal Ar terminal
+Set the default terminal for new windows created in this session - the
+default value of the
+.Ev TERM
+environment variable.
+For
+.Nm
+to work correctly, this
+.Em must
+be set to
+.Ql screen ,
+.Ql tmux
+or a derivative of them.
 .It Ic escape-time Ar time
 Set the time in milliseconds for which
 .Nm
@@ -2281,18 +2294,6 @@
 This option should be configured when
 .Nm
 is used as a login shell.
-.It Ic default-terminal Ar terminal
-Set the default terminal for new windows created in this session - the
-default value of the
-.Ev TERM
-environment variable.
-For
-.Nm
-to work correctly, this
-.Em must
-be set to
-.Ql screen
-or a derivative of it.
 .It Xo Ic destroy-unattached
 .Op Ic on | off
 .Xc
--- a/tty.c
+++ b/tty.c
@@ -34,6 +34,7 @@
 void	tty_read_callback(struct bufferevent *, void *);
 void	tty_error_callback(struct bufferevent *, short, void *);
 
+void	tty_set_italics(struct tty *);
 int	tty_try_256(struct tty *, u_char, const char *);
 
 void	tty_colours(struct tty *, const struct grid_cell *);
@@ -450,6 +451,21 @@
 }
 
 void
+tty_set_italics(struct tty *tty)
+{
+	const char	*s;
+
+	if (tty_term_has(tty->term, TTYC_SITM)) {
+		s = options_get_string(&global_options, "default-terminal");
+		if (strcmp(s, "screen") != 0 && strncmp(s, "screen-", 7) != 0) {
+			tty_putcode(tty, TTYC_SITM);
+			return;
+		}
+	}
+	tty_putcode(tty, TTYC_SMSO);
+}
+
+void
 tty_set_title(struct tty *tty, const char *title)
 {
 	if (!tty_term_has(tty->term, TTYC_TSL) ||
@@ -1360,12 +1376,8 @@
 		tty_putcode(tty, TTYC_BOLD);
 	if (changed & GRID_ATTR_DIM)
 		tty_putcode(tty, TTYC_DIM);
-	if (changed & GRID_ATTR_ITALICS) {
-		if (tty_term_has(tty->term, TTYC_SITM))
-			tty_putcode(tty, TTYC_SITM);
-		else
-			tty_putcode(tty, TTYC_SMSO);
-	}
+	if (changed & GRID_ATTR_ITALICS)
+		tty_set_italics(tty);
 	if (changed & GRID_ATTR_UNDERSCORE)
 		tty_putcode(tty, TTYC_SMUL);
 	if (changed & GRID_ATTR_BLINK)
